
using System.Collections.Concurrent;
using System.Formats.Cbor;
using Chrysalis.Cbor.Types;

namespace Chrysalis.Cbor.Converters.Primitives;


public class UnionConverter : ICborConverter
{
    public void Serialize(CborWriter writer, object value, CborOptions? options = null)
    {
        CborSerializer.Serialize(writer, value);
    }

    public object Deserialize(CborReader reader, CborOptions? options = null)
    {
        byte[] encodedValue = reader.ReadEncodedValue(disableConformanceModeChecks: true).ToArray();

        if (Convert.ToHexString(encodedValue) == "A278383266363333303831663862393563396130313630666361666332666631386632363736363334363333636363396464643061376362323564B832684C4643316F663235A3646E616D656B4C46432031206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643326F663235A3646E616D656B4C46432032206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643336F663235A3646E616D656B4C46432033206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643346F663235A3646E616D656B4C46432034206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643356F663235A3646E616D656B4C46432035206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643366F663235A3646E616D656B4C46432036206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643376F663235A3646E616D656B4C46432037206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643386F663235A3646E616D656B4C46432038206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F684C4643396F663235A3646E616D656B4C46432039206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331306F663235A3646E616D656C4C4643203130206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331316F663235A3646E616D656C4C4643203131206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331326F663235A3646E616D656C4C4643203132206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331336F663235A3646E616D656C4C4643203133206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331346F663235A3646E616D656C4C4643203134206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331356F663235A3646E616D656C4C4643203135206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331366F663235A3646E616D656C4C4643203136206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331376F663235A3646E616D656C4C4643203137206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331386F663235A3646E616D656C4C4643203138206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464331396F663235A3646E616D656C4C4643203139206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332306F663235A3646E616D656C4C4643203230206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332316F663235A3646E616D656C4C4643203231206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332326F663235A3646E616D656C4C4643203232206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332336F663235A3646E616D656C4C4643203233206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332346F663235A3646E616D656C4C4643203234206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F694C464332356F663235A3646E616D656C4C4643203235206F6620323565696D6167657835697066733A2F2F516D5A477A5A39793967576D53356D616D33324771694373475066473134436332357745464A477A59506F656A4569617277656176654964782B4C5530746D516758744843737A3778733661477432507A3768477A58774A70314739386B75515A6C72306F724C6F7665466F7243727970746F316F663235A3646E616D65754C6F7665466F7243727970746F2031206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F326F663235A3646E616D65754C6F7665466F7243727970746F2032206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F336F663235A3646E616D65754C6F7665466F7243727970746F2033206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F346F663235A3646E616D65754C6F7665466F7243727970746F2034206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F356F663235A3646E616D65754C6F7665466F7243727970746F2035206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F366F663235A3646E616D65754C6F7665466F7243727970746F2036206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F376F663235A3646E616D65754C6F7665466F7243727970746F2037206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F386F663235A3646E616D65754C6F7665466F7243727970746F2038206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F396F663235A3646E616D65754C6F7665466F7243727970746F2039206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31306F663235A3646E616D65764C6F7665466F7243727970746F203130206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31316F663235A3646E616D65764C6F7665466F7243727970746F203131206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31326F663235A3646E616D65764C6F7665466F7243727970746F203132206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31336F663235A3646E616D65764C6F7665466F7243727970746F203133206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31346F663235A3646E616D65764C6F7665466F7243727970746F203134206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31356F663235A3646E616D65764C6F7665466F7243727970746F203135206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31366F663235A3646E616D65764C6F7665466F7243727970746F203136206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31376F663235A3646E616D65764C6F7665466F7243727970746F203137206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31386F663235A3646E616D65764C6F7665466F7243727970746F203138206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F31396F663235A3646E616D65764C6F7665466F7243727970746F203139206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F32306F663235A3646E616D65764C6F7665466F7243727970746F203230206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F32316F663235A3646E616D65764C6F7665466F7243727970746F203231206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F32326F663235A3646E616D65764C6F7665466F7243727970746F203232206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F32336F663235A3646E616D65764C6F7665466F7243727970746F203233206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734734C6F7665466F7243727970746F32346F663235A3646E616D65764C6F7665466F7243727970746F203234206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A717535363866567734724C6F7665466F7243727970746F316F663235A3646E616D65764C6F7665466F7243727970746F203235206F6620323565696D6167657835697066733A2F2F516D57645A764872584366314A6B525566724E3569414B6A32674534627A58657171666D48436451356F424C376769617277656176654964782B72314E6849674A33623942683259663752747254314233383569744C5A487649357A7175353638665677346A706F6C6963794C696E6B7835697066733A2F2F516D61774A655957577176675439515876754D476858394E76683552745933316E4C674A7646445A57314C745177")
        {
            Console.WriteLine("Deserializing UnionConverter");
        }
        Type baseType = options?.ActivatorType ??
            throw new InvalidOperationException("Union type not specified in options");
        IEnumerable<Type> concreteTypes = options?.UnionTypes ??
            throw new InvalidOperationException("Union types not specified in options");

        if (baseType.IsGenericType && !baseType.IsGenericTypeDefinition)
        {
            Type[] typeArgs = baseType.GetGenericArguments();
            concreteTypes = concreteTypes
                .Select(t => t.IsGenericTypeDefinition ? t.MakeGenericType(typeArgs) : t);
        }

        foreach (Type concreteType in concreteTypes)
        {
            try
            {
                object? result = CborSerializer.TryDeserialize(encodedValue, concreteType);
                if (result != null)
                {
                    if (result.ToString() == "LoveForCrypto1of25")
                    {
                        Console.WriteLine("sda");
                    }
                    options.ActivatorType = concreteType;
                    return result;
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                // Continue to next type if this one fails
            }
        }

        throw new InvalidOperationException($"Unable to deserialize to any concrete type implementing {baseType.Name}");

        // public object Deserialize(CborReader reader, CborOptions? options = null)
        // {
        //     byte[] encodedValue = reader.ReadEncodedValue().ToArray();

        //     Type baseType = options?.ActivatorType ??
        //         throw new InvalidOperationException("Union type not specified in options");
        //     IEnumerable<Type> concreteTypes = options?.UnionTypes ??
        //         throw new InvalidOperationException("Union types not specified in options");

        //     if (Convert.ToHexString(encodedValue) == "8201D818583CD87A9FD8799F581CE33BB9C5E634BC5BE187EABA0D94725EF71505D4A4CA6E0FED0B2E6DD8799FD8799F1A0005B9801B0000019096A7E9B2FFFFFFFF")
        //     {
        //         Console.WriteLine("sda");
        //     }

        //     if (baseType.IsGenericType && !baseType.IsGenericTypeDefinition)
        //     {
        //         Type[] typeArgs = baseType.GetGenericArguments();
        //         concreteTypes = concreteTypes
        //             .Select(t => t.IsGenericTypeDefinition ? t.MakeGenericType(typeArgs) : t)
        //             .ToList();
        //     }

        //     // Try first type synchronously
        //     foreach (var type in concreteTypes.Take(1))
        //     {
        //         try
        //         {
        //             object? result = CborSerializer.TryDeserialize(encodedValue, type);
        //             if (result != null)
        //             {
        //                 if (options != null)
        //                 {
        //                     typeof(CborOptions).GetProperty(nameof(CborOptions.ActivatorType))!
        //                         .SetValue(options, type);
        //                 }
        //                 return result;
        //             }
        //         }
        //         catch { }
        //     }

        //     // Process remaining types in parallel
        //     var remainingTypes = concreteTypes.Skip(1).ToList();
        //     if (!remainingTypes.Any())
        //     {
        //         throw new InvalidOperationException($"Unable to deserialize to any concrete type implementing {baseType.Name}");
        //     }

        //     var tasks = remainingTypes.Select(type =>
        //         Task.Run(() =>
        //         {
        //             try
        //             {
        //                 var localOptions = new CborOptions(
        //                     ConverterType: options!.ConverterType,
        //                     ActivatorType: type,
        //                     PropertyIndexTypes: options.PropertyIndexTypes,
        //                     PropertyNameTypes: options.PropertyNameTypes
        //                 );
        //                 return (Type: type, Result: CborSerializer.TryDeserialize(encodedValue, type));
        //             }
        //             catch
        //             {
        //                 return (Type: type, Result: null);
        //             }
        //         })).ToList();

        //     while (tasks.Any())
        //     {
        //         var completedTask = Task.WhenAny(tasks).Result;
        //         tasks.Remove(completedTask);

        //         var (type, result) = completedTask.Result;
        //         if (result != null)
        //         {
        //             if (options != null)
        //             {
        //                 typeof(CborOptions).GetProperty(nameof(CborOptions.ActivatorType))!
        //                     .SetValue(options, type);
        //             }
        //             return result;
        //         }
        //     }

        //     throw new InvalidOperationException($"Unable to deserialize to any concrete type implementing {baseType.Name}");
        // }
    }
}