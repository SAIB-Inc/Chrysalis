using System.Reflection;
using System.Text.Json;
using Chrysalis.Cardano.Core.Types.Block;
using Chrysalis.Cardano.Crashr.Types.Datums;
using Chrysalis.Cbor.Converters;
using Chrysalis.Cbor.Types;
using Chrysalis.Test.Types;
using Chrysalis.Test.Types.Cardano.Crashr;
using Chrysalis.Test.Types.Primitives;
using Xunit;

namespace Chrysalis.Test;

public class CborTests
{
    [Theory]
    [MemberData(nameof(BoolTestData.GetTestData), MemberType = typeof(BoolTestData))]
    [MemberData(nameof(BytesTestData.GetTestData), MemberType = typeof(BytesTestData))]
    [MemberData(nameof(IntTestData.GetTestData), MemberType = typeof(IntTestData))]
    [MemberData(nameof(LongTestData.GetTestData), MemberType = typeof(LongTestData))]
    [MemberData(nameof(UlongTestData.GetTestData), MemberType = typeof(UlongTestData))]
    [MemberData(nameof(TextTestData.GetTestData), MemberType = typeof(TextTestData))]
    public void Deserialize(TestData testData)
    {
        Assert.NotNull(testData);
        Assert.NotNull(testData.Serialized);
        Assert.NotNull(testData.Deserialized);

        byte[] data = Convert.FromHexString(testData.Serialized);
        Type actualType = testData.Deserialized.GetType();

        // Act
        MethodInfo deserializeMethod = typeof(CborSerializer)
            .GetMethod(nameof(CborSerializer.Deserialize))!
            .MakeGenericMethod(actualType);

        object? actual = deserializeMethod.Invoke(null, [data]);

        // Assert
        Assert.NotNull(actual);
        Assert.IsType(actualType, actual);
        // Assert.Equivalent(testData.Deserialized, actual);
    }

    [Theory]
    [MemberData(nameof(CrashrTestData.GetTestData), MemberType = typeof(CrashrTestData))]
    public void DeserializeCrashr(string testName, string serialized, CborBase deserialized)
    {
        Assert.NotNull(serialized);
        Assert.NotNull(deserialized);

        byte[] data = Convert.FromHexString(serialized);
        Type actualType = deserialized.GetType();

        // Act
        MethodInfo deserializeMethod = typeof(CborSerializer)
            .GetMethod(nameof(CborSerializer.Deserialize))!
            .MakeGenericMethod(actualType);

        object? actual = deserializeMethod.Invoke(null, [data]);

        // Assert
        Assert.NotNull(actual);
        Assert.IsType(actualType, actual);
        CrashrTestData.AssertListingDatumsEqual((ListingDatum)deserialized, (ListingDatum)actual);
    }

    [Theory]
    // conway
    [InlineData("84828f1a00527c331a015fb132582019e8dec30df21e161115b6ae1bbae809254b590e9e6e8c35a4f2128bacf96fe25820b65a4200ffc36c505064abb975d7fe3fc55ffc4d815f4542df2a0ef83fb3801c58204748aba9cfd2cf3d68dafaa6974528bd8da01e57d6e83f62083c3ea99808615c82584044d71405fb96955167c0993fc11f66994f5dbca45b6e2f8bb68c52799603135cc66720b2910b41d118ebfd587e6f8135cd10c73403ab4131906459f1c0122d9d5850fb6755181d62666b99c6b0d37900838cc08d472545ee89d93fc8fbefcb83ffc30fa61a6c0207366bf88e63a3eb8a4b11e47b586054b1a5c259cd9dc90ca82dac7336857a9a875de52d1768b4c74810048258400001ecfcf4748e1a32960e323a5d636244d61979647357560d2d919ccc85908355e9ed9f4c575a5332305b82bc6e46ae8c304ad46fe1fc67dbde530d2581066e58500c8c4fdeaf8767bca8b323b1c1b324365b32ac7b1a7b58f3658426f9ea1daf92144e27f83946d424b60c495eee6001f33f801933cf5aed8e61769c116648ab95f3df5f8e4161288769819ed0c13bfe07190bbf5820bcd2bababa216b2476d660eebb92e000ed4ece5f5a9de15b857e69e291c7e48358200e9d108df1cac53c21e9d2409c636e18e456d77ef8774c9e98d9424ff9f6a4bf01188c584087a003220b84794898c692392321d906e7b780fadaba396d496c271725be43c0e1551e778df00ac6d1a32ad9abace2f801f9aeb915972c2fc187d443687b6e0204005901c052872ebf29ce234e7cf6f66876f1d309cd6dc2efc8879422586daa8fca4009c4484bdd3ed7e9cb5e9bf90c5c78a4d0d92ccc601a7febed8dca4da0eb0cc5890d9fbcb7bf5ab8a4aadb5475b232c46200efa0d236ea0dc9fbcfec17c14cf6b6637e7e2922e8483be6e88289cf8a5df7dbcd42f2b6954e55c7011333ffa2b2732bf401a8944302f3b9250f1b24390a6a735ee7a65a0425b5ab1e4da0eb783561c54eac7019ec04d2ebfec992b700b005129d31a49d48da03e72409190c1d7b223ad76df9b4acf52f264d86b2d37b71c8cf6cb67b6e047d4f255dff2fee521e26e805afba3398cc07aec495b25b741b05bd5aec318cd03d77cafc72ae789cdbc76804af08ea62ae10efc3f7c760a93926b03476ecb57e2bc317d15cc4f65ac0f1fac37f08ceab90e504b090d4ab0df00c83998d028818572b02801c95a238eeaf993c7e6ef852d9623c3dbedbaf20e492a03fe849433772347834a3b662bcdd33b3466dbaf462fcbe1e80bf956f7060a59e70235e037fcdadfc27f2308030b0d53f73e53ce439a070d5f84b0f8de24f05923e958ad516b10f597e030d15589a2b2ce456b2769a4f638599450997490a469531918ab2c00512c69731308f70bc436484a40081825820cc8ffe5f1eddbcee49f7e3b45355213686d1a16f538083768c4f5014ea07ee2100018282584c82d818584283581c1216b1674c9b4d902883d167ce2b1854cee8198b2b23c16790c20aa9a101581e581c2cb78b2d298752586da8a184ab66e80b165d4fcec7d1fa273433c402001aaa8f1fc21a626354cf82583901d2b582c2cc9844a21748b8c561d6b50096340701e260fe45646f7ce87d67d6985affc837f5eb36deddfbd77331bf7dfc9be66dc33ff094161a02edf7cc021a0002a465031a015fcd47a50081825820d7ad2b64b5b88c84e9a2b31f4f316a6cb05347fa3c2cdbc564d25b37c1beefc30c018182583901b275e33329f7ae59b8617411073615f44187421dd33d983ae14b0bd2a08be3dc4b41c314e44b883624d9988795e97504ef542d4c98228c391af6da2be2021a0002a8b1031a015fcd2d048282008200581ca08be3dc4b41c314e44b883624d9988795e97504ef542d4c98228c3983028200581ca08be3dc4b41c314e44b883624d9988795e97504ef542d4c98228c39581cf1b265f1e545da9c6e003c5d703fb5a23283c646cd40b2d619671e7fa40082825820129914af1860678d177d0a4e608b2d65d743a373c2d486e68f63dfca86c485a70182582028bc08a610764695bff6cf68cb0a9bfb49205af2efa194a7ca2ef0d1b3eb1d6407018282583901f916d78bf849c37de87417b5d3a338317b79376d69f32724ddf2a2d1f916d78bf849c37de87417b5d3a338317b79376d69f32724ddf2a2d11a0be8b4c082584c82d818584283581c9ed07c4d376778fe73bdf02b3030b4138cd45a9db41f67f49ab58a37a101581e581c3083349abf53ea9ad19e9450464207e560586da9f5bc414ca9c876de001aff425bc61b000005613639af4f021a0002cb3d031a015fcd4aa40087825820076a89a91f48dbca770a3c185b51918ebbaf8cfdcaffb0db7fd65f8a7107b41e0c8258202401d4d98372ce349e7a6fc6af33acf3df6a5d90db19e5e1e4a430812bd13a9a0082582045e0835cbe270c3b068ca356419b6a13084378652f392cb546e597ca7e32d244008258206b3b8b922e83684ac4bc4ae258b9ebda837f668654f2e53a2f14230c14c460f9008258206e33c9d636f916e9f0c491555514cc31dc5e16b17ad2376436431160572e1c360182582090e535f35fdb239714d07064ad36b792cbceb7b0d99fb5dfe0ed7bed74e0678900825820ca9a3353f8f5733933a79c3c6c1c050a690aae8465c6ead927a3a9d2e803833000018282584c82d818584283581c68be23727445c24415c6b078dfce1a6ea973c63eb2317bfb60a8d923a101581e581c2cb78b2d2987521e011f0184dda7d520e1815a27f443c499bf886e2a001a33144c3b1ac7e8f5fb825839010f1167abf60b473e36b556077811d4a41714eda237e95d722fd63570eca8d0ccc8368cf5d927ef81fab1554dee7906d50c58d817320587951ada91fac0021a00038745031a015fcd4d84a102818458208825205f2483877ff7350ab296449ba383f82bb7c2604bb02b6ab2aa6096aa635840b2b18e987974e37477f80df064d33bd17356e5ff2a258515176f7517266b7f4319e653bfe24a9a88bd521accb8b39dbfe1bd7a266ef5b278c54cdf22de9b2707582073765eaf2fac6a18c3154dc35ebe9680428a61135898a3ea120f6308acf8ec6b5822a101581e581c2cb78b2d29875256935d1a843269ed0590f717314d4cdf866b315775a10082825820635993a26c14dd9019efa50cd4ce95a147a5ae332ca14c07489292d6cd4af7785840d645d6e4dac44f7a8845afd1c7ae419a896941690580af1b13ae1fa0a6997d8b56ec8c43f8fe7ddd7aa10c57162b008a1d93071bff3366448d590f53269dfb08825820049fcafea3c1472107c6589e78ee163ff83e60b05fd6209dec35ec4f03f7e7cf5840139f26e56b23f5e95788650d12531a7aa9998b367326e3c83c51e17020324d657659993fc51b08b9709d27c2131a13d341194c9f2ffe6a8fcc5f6540b8923f08a10282845820c1ffc34160174c939f17f07d5e9248231e19d966e47098258a55c900dfc9d3bd5840f6a90b68b6d870e3728fb8f9be8e35b492b181270944b3fa9dcb8ef7a5c8ca5cd7949b2ac8b421a403539c0758d71eea1fee3b377fccef4598923c57bbe4060a5820bb95000206f79a3e893f30c40c6ff87efdebe0188025d00888b17df23e28446a5822a101581e581c3083349abf53eadad9483a501fdd4c655dc63b878a99301d97ae6102845820997f3fdd280bc2af629240afc83f07f0a570af0a42c52a50d18239d5303bb284584053e0e4a22e5bd10e3053dc0aa883db77bb0ea27e6718673ff83b385a0d1cdd240761a5dc69103f0c9988ade89a6ca8bfa2c43a101c5a78fe24431ec940ec13015820fe61c42716add8563f76484d314c290d55ac4b7d2250aa3d9a80e62226c241395822a101581e581c3083349abf53eab498612350bb23df0159d2a6be2fcc52a7731e1b10a10287845820cd9c9534e1e9c83f7606477db856309f4c403e270eb0a175c14ac1675281912258403aeeec8686e269c897aba8a40398299d588a274c99e952c4cbbc0771ca84251f0e83d74ca2ba04b2b0eb22324cf379c938118a83bf43317bc527e16715c49a065820e228f4e25cf1f3c77ed1d372ce0a141700b5474ceacf745cfcb65bc841c9d0bb5822a101581e581c2cb78b2d2987525693a3c4842fa08566697827084d959224b2b973da845820820504e1218a034b2dba056a120fbcbd3b6dec2f50408440f27d22fd0f881e935840d2ba11018d8f75b5eb575c69c20111f160f006957aafaeb8efeb8a0a2bcd90bad9ae932b05465a57d38fd2841071dafdfd8b95635480a1717518b07bcce6e3045820291023ee372563c26551d482b3bf068e0343a7e3059b697f1390e2269f1182d55822a101581e581c2cb78b2d2987527500f5b6846533439461772bc086e64ee1d96d8d758458205a11b4ef17c6f4749982afedc9613f9aba2700559b670d0cbd49259daf459235584092a643cffbbd5739380322de72b23b764a4b24a1bf0472880bcc014fdfb3ef8da3b7cf28d9978d75358b44751c71e09e96bc0eb87d8f92b798e3d2b91bbc5f07582011eec758d9ca8feaa2d9c1d5b4a6b9713154b5e2c641e32d65a9564697df9aee5822a101581e581c2cb78b2d298752569036f884fded19b659fa9728101693be5a5e0239845820b348baa3ca6b57119fc972f7835ab6bdf9db1ddc910714f78cdcb060f06b0b8a5840b35527ee246890531a062e8cbd45b6b731dcd03b476793a027a05070a065cbb30a8ac406b817eb4847db0d43a62e0dd41a2a90e20a9a28cb6014aaaecabe920358206fbe90398580bb07d7af8a5d7d00ddacb0d0e2d55ef80202c85c84d6429420265822a101581e581c2cb78b2d2987525693aafe842c609882c5c35cbbaef412a76cecfa0784582015369f3af03861da2e51fb6bab1eb0129e8217b393a76aa08f30ffd9b3aec9ff584083f3d2972cc86f2185738466f769b662e4c3c360535a57717f2ebbd51e30c8af586e16fe7cec72aee45d22a2b652abca9c76e60086f53f479366247a5945280c58201aae99fdd87432fdc4f8a702c8985fdbfa6885d4aff3f005cf7356d36d3629195822a101581e581c2cb78b2d2987525690737d84bce1193d9eb78934d8ddc9bee17ecaba84582005d41288dbafc63b247cb2cec773372e59a42772c107a8d9fd06692e2bc548945840792764d4180948c7f8d637ff4bebca639109162c4cdc8c17e1c9ea97402ae68a9800701ee8d71d2ea85bd0426e0e829879997e18f2e86d1ce842ced1affc680958203a52e7e7ebe204c9291d960e2d4b81a532f34e7ff78791c01a899d1f0664b2955822a101581e581c2cb78b2d2987525693efd3846c06c238e49a5bf6f237d6fd85028a9f8458200beb3362fc3817d92d0d9fea1d4fd1149c6d00f964125cf8bbb9b9ef1b8cc5155840d76aa83f009729ccf22f0dfde37e74151176cf92791356fc5d8792f12820cbf0be41a4420be26e23d36e617e781f26a30f890cfdfce65dd8252fdc6e4e34cf0e5820eab60523d3fc1773a939e1c5ffc3564db0660af663ae62c2d62bf1c98de0a7345822a101581e581c2cb78b2d29875256939b5a843b2b70252956da6e5e3e077aced55d13a0")]
    public void DeserializeBlock(string cbor)
    {
        Assert.NotNull(cbor);

        byte[] cborRaw = Convert.FromHexString(cbor);
        Block block = null;
        try
        {
            for (int i = 0; i < 1; i++)
            {
                block = CborSerializer.Deserialize<Block>(cborRaw);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }

        Assert.NotNull(block);
    }
}
