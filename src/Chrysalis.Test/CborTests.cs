using System.Reflection;
using System.Text.Json;
using Chrysalis.Cardano.Core.Types.Block;
using Chrysalis.Cardano.Crashr.Types.Datums;
using Chrysalis.Cbor.Converters;
using Chrysalis.Cbor.Types;
using Chrysalis.Test.Types;
using Chrysalis.Test.Types.Cardano.Crashr;
using Chrysalis.Test.Types.Primitives;
using Xunit;

namespace Chrysalis.Test;

public class CborTests
{
    [Theory]
    [MemberData(nameof(BoolTestData.GetTestData), MemberType = typeof(BoolTestData))]
    [MemberData(nameof(BytesTestData.GetTestData), MemberType = typeof(BytesTestData))]
    [MemberData(nameof(IntTestData.GetTestData), MemberType = typeof(IntTestData))]
    [MemberData(nameof(LongTestData.GetTestData), MemberType = typeof(LongTestData))]
    [MemberData(nameof(UlongTestData.GetTestData), MemberType = typeof(UlongTestData))]
    [MemberData(nameof(TextTestData.GetTestData), MemberType = typeof(TextTestData))]
    public void Deserialize(TestData testData)
    {
        Assert.NotNull(testData);
        Assert.NotNull(testData.Serialized);
        Assert.NotNull(testData.Deserialized);

        byte[] data = Convert.FromHexString(testData.Serialized);
        Type actualType = testData.Deserialized.GetType();

        // Act
        MethodInfo deserializeMethod = typeof(CborSerializer)
            .GetMethod(nameof(CborSerializer.Deserialize))!
            .MakeGenericMethod(actualType);

        object? actual = deserializeMethod.Invoke(null, [data]);

        // Assert
        Assert.NotNull(actual);
        Assert.IsType(actualType, actual);
        // Assert.Equivalent(testData.Deserialized, actual);
    }

    [Theory]
    [MemberData(nameof(CrashrTestData.GetTestData), MemberType = typeof(CrashrTestData))]
    public void DeserializeCrashr(string testName, string serialized, CborBase deserialized)
    {
        Assert.NotNull(serialized);
        Assert.NotNull(deserialized);

        byte[] data = Convert.FromHexString(serialized);
        Type actualType = deserialized.GetType();

        // Act
        MethodInfo deserializeMethod = typeof(CborSerializer)
            .GetMethod(nameof(CborSerializer.Deserialize))!
            .MakeGenericMethod(actualType);

        object? actual = deserializeMethod.Invoke(null, [data]);

        // Assert
        Assert.NotNull(actual);
        Assert.IsType(actualType, actual);
        CrashrTestData.AssertListingDatumsEqual((ListingDatum)deserialized, (ListingDatum)actual);
    }

    [Theory]
    // conway
    [InlineData("85828A1A00A846CA1A08444B855820EF6E8FF353426D61896C85A6CD72D8769A90EADAFA115C70AD5F4A500C68D3475820654CE74EAD58C1C071480B49017CAF7F1E5D6E5B38393D9D6830186771ED22F25820E096EE4825A069B659B1873757266D501066AF91C1DF6BF3792E1E536F79D97E825840BE40257BDA55203DFC1E5792E9C04F86F5391ED9984358D2A36405952294FAEF17061A39B981396138927D83EEEDF0249EE043E794B046256D9849ECB97DDB4B58503EF29269DD127560C9CA56487F63A9CEDAC4DC31E13939A8623C7A78014C7BFBCEB8A370CBBD6E236E5269BBC96B6B9844FF57752618D844BD75B6A94BE02750A1807B86A030977A7EC37A2EB4BDBF0519210458204FE727A622228E3DAB02125012E18B3FBA5AC73300BC49CC210DE3D6E29D489D845820F8CE9C00C14A66B26FCB405B2FE29641DA3525598F65201B504C37FD9FEDD149181C19041B5840E0C42C2AF9EE76FE7288E23E6FBD850C5F5849B4AF2280CFDFEB45744CC7BE72A3C6E35B5ADA363FFD27EFB937611E9193817309A1DDB1BEAB741FCBBE2F2D0A8209015901C081738512E10B15E5641321088C3D2EE8C502A33C3C1092B9FF4834B179102DF438D290A3C230CD2D54442752219905D3DAF717D0D06BC912819EB7A5388B020093B4C3F0246D7EAD77AD4736D035F1189C4BECC330EB3E1B357C6B264905B1C6521893E69F8FD322232B9A7F7EEC8A95CF76F61E444BD70224F9D3D49B4834ABC64D028FB335DBFD8BA238CAE6C39F25BA6CD03C33DFA1670DEEE1643DA07846B0E9B0537C9EA698868548D94C19EDE5B166382C025FC7B27595A212DC49ACBBEE0AF0CFCDE3029A31A6C52349EE2E4816F24DDEE3955FA145C9AACE5028FCA168E8438B141906BA46DF3D8E897733F40874C0F2302DD9E5A6A61E06CB156E9D7D0309D864893263FA647E0314254E079F1D7E55E55F6E7DAE9B59CEC685EF85F81957D25DDC655157A4028BF12878A78040D23191A05BBFF09FAC19B4DEC677732306ED26FF6EA0146E6447425299D2B68696FE9E9FB66DD42F43384994B33DCC5FF8D2F50B348136601F690CB8AA9774C7B20E0DA8B53234896AAB4F995F383845C558356A5539595040416A84BEE569E0F9DBFEFD410850FD6A8FE22B2D70E5DD5C10354DAF1C6DAFA017BF56A41555824E84190776055447FBEC3E1442818BA900838258202DB14AB864618B1122A64833821A2D1F27D2093903CD54A739D794664AADC5FE0082582092E608F4CF0AFB3B8E0A8E6DCB9851CFBFC57F644B7220BB7BEFD7664FDA63CC00825820ADEB557995EE9B8D7A1F804EE7D6406F37DD623DED07752AD28FE409BBA0651B020183A300583911AF97793B8702F381976CEC83E303E9CE17781458C73C4BB16FE02B830AC31F2D917E3138C55E66CF93141C814FB9708C18A789A3C21F41F801821A82AF47C3A2581C6FDC63A1D71DC2C65502B79BAAE7FB543185702B12C3C5FB639ED737A2414C015820A721B984DA1AF326CBEB062B7230206E111CF0E24DA83DF5148E97B26919D67C1B7FFFFFFF03740E66581C95A427E384527065F2F8946F5E86320D0117839A5E98EA2C0B55FB00A14448554E541B00000001F0E78FE4028201D8185874D8799F581CC134D839A64A5DFB9B155869EF3F34280751A622F69958BAA8FFD29C4040581C95A427E384527065F2F8946F5E86320D0117839A5E98EA2C0B55FB004448554E54181E0500001927101A001E84801B00000192DB84AF981A002556E41A00A154A600000000D87A80D87A80D87980FF825839017FBB4763847B9EC49A132D5359BD86AAECDE9275A03AEF294FFB79D0FA34F3B651ECB6A75834C80DC1FD162FEB1D1B4CDCEF0D065A5785AA821A003010B0A1581C95A427E384527065F2F8946F5E86320D0117839A5E98EA2C0B55FB00A14448554E541A100CC452825839010B46751422F2357DD4ECEE5A84B288B982B20375A0503CC7ECDDA5AA47754858DDD2795AAB89617D72D7D240ABCCD036FA4B761FA39787A3821A04F95C1BA1581C1AD3767073087DF4FC97FBA7AC4A71A0A6CD556F1AD96A7B1C9870C4A1415801021A000750F7031A08446072081A08444B5C0B5820BF3B9C8BA417C18C7D83D16509D41AB0A297D2F2AC87EB61349548DEFEDFCBD00D8182582063C5DEA8DA9F5241AC8D6359354F2B322AEA0698EBD59845D62F362D6DDDB6F6000E81581C0B46751422F2357DD4ECEE5A84B288B982B20375A0503CC7ECDDA5AA12828258205EC56338104FCBFE32288C649D9633F0D9060ABCE8B8608B156294F0A81D29E201825820BABC647257B8D78B86E862BA9769401714ED403E7C46ED1B59C3FC32E0247C8200A40081825820CBD2893F7EB5F02E25C4A4FCA2272C3EB8F04264E6FC6CF7A766676A6E3B579D01018282583901DC36284268BD50351659A4C60381B0BBF18BE5F465A9971AC350C251A71EF71005C80F23B9951C36F0A79407F20A5745F59AE85EAAC6CE131A0385DBDE82581D61D91EF01B73F3010BB173945CF5417257C00C002715A13052015AB54F1A02664935021A0002CD30031A0844596CA300858258203966019E8777746C698930271541A0C2025B1601FD9C8EAC86B4E503B476DCF104825820678EEC2E5E9FB8C1DEACC31276DDD21983B80D67A3635EE6C5FBACDE6514A1D3038258206EE8AAE4F468D747CD1B929499E50DA36D9D580C482343CF0200C1296D9761F60382582073EB0192149F8B9392AECE9C0A3BDBCBB5F854335CF925DB195C2C6CC314FB5702825820D85B78DCDE08345BBE2DB8D3EAAF05A9902C4D7C97466E59BA05D3689944C7D7010185A300581D71C3E28C36C3447315BA5A56F33DA6A6DDC1770A876A8D9F0CB3A97C4C01821A003567E0A1581CE5A42A1A1D3D1DA71B0449663C32798725888D2EB0843C4DABECA05AA151576F726C644D6F62696C65546F6B656E581A38616F14028201D818590130D8799FD8799F581C63FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545ADFFD8799FD8799F581C63FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545ADFFD8799FD8799FD8799F581C4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C950FFFFFFFFD87980D8799FD8799F581C63FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545ADFFD8799FD8799FD8799F581C4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C950FFFFFFFFD87980D8799F581CF5808C2C990D86DA54BFC97D89CEE6EFA20CD8461616359478D96B4C5820686DB0C143A3A2CC19099D8909E315C4ED761A6AC5A3C5998C651D5E9D3CB253FFD8799FD87980D8799F1A38616F14FF1A1F988640D87980FF1A0016E360D87A80FF8258390163FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545AD4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C950821A001E8480A1581C29D222CE763455E3D7A09A665CE554F00AC89D2E99A1A83D267170C6A1434D494E1B0000000BA43B74008258390163FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545AD4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C950821A001E8480A1581CE5A42A1A1D3D1DA71B0449663C32798725888D2EB0843C4DABECA05AA151576F726C644D6F62696C65546F6B656E581A5B05BEBF8258390163FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545AD4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C950821A001E8480A1581CE5A42A1A1D3D1DA71B0449663C32798725888D2EB0843C4DABECA05AA151576F726C644D6F62696C65546F6B656E581A5B05BEBF8258390163FF16ED0B3B904E7B6DA17D8EBB0C9869F700340BAF5B375D7545AD4D9BC45E5D191E408941D18DBBAC1D7CA737EB82134D12DA3D28C9501B000000023EEF3A12021A00032159A500D9010281825820B6AF09FB77EC8128625F07311B4EE78042C535A4759B906D97C97B62CB03310E00018182583901A521FCC70B1067A74C710DC4B9A936379352BE69ACF557D792EB7C6A19E1196351C34DDA37F60878EDD91BA863484B18BA75E613BB0A3C691B00000093B6239679021A0002E76D031A0844716E04D90102828A03581C09C932D2D572053C44F9162DFC8CF5E271AB1B3BDC1815B3D51C5151582003857824B92C68F67E176982EF11B45E6B0E1541305FFA532ECC81DF916755221B00000092AEED1C001A0A21FE80D81E820001581DE119E1196351C34DDA37F60878EDD91BA863484B18BA75E613BB0A3C69D9010281581C19E1196351C34DDA37F60878EDD91BA863484B18BA75E613BB0A3C69828301193500716275646431612E616972646E732E6F7267830119350B716275646432612E616972646E732E6F726782783768747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6F64796E672F62756464612F662F6D392E6A736F6E58203A9914695D787236D65001E89838DCFA90702AFC9FC86450A8B4C506CD3FCC7B83028200581C19E1196351C34DDA37F60878EDD91BA863484B18BA75E613BB0A3C69581C09C932D2D572053C44F9162DFC8CF5E271AB1B3BDC1815B3D51C5151AC00838258202BD18398F6D845C535038297208E8E0D08DC2F5F7401BFFCCB0E9733CFB7764300825820666225C3089B199FD3D1827BF967BB3DD71B9DBAF26E248F2727F62DB8CAB75100825820A8A0BFC5E3AD6DFA48A31157CD1737113271F0F4ABF81765DD848089A8810B9D01018382583901ADB1BF6A51B20FF1B8450726EF3891BB0E153D5BF47783375E2134AFBD6A096CBBA5E259946798E948403E2D2B3D9EA88A12EE8E7AE94497821A001C3D92A1581CD195CA7DB29F0F13A00CAC7FCA70426FF60BAD4E1E87D3757FAE8484A1476876424541524408A300581D71B15A1A010843E8AFB6F963B03D452BE815B533DAD0CD23D819C2D20101821A001FB2ECA1581CF5808C2C990D86DA54BFC97D89CEE6EFA20CD8461616359478D96B4CA1582052BD1E5A642E2141E8FB7EA6FA996960BC91DB0B040C6D35013CF3EFECAC2DFC1A00B00C73028201D81858CCD8799FD8799FD8799F581C814E1D11330F398CBF52DA38AD71926A3579C18D5F95D78FF6C64DF3FFD8799FD8799FD8799F581C7EF835A10E065DBACA71D9604348BD140E67D10E23C3C7D40E2B10C5FFFFFFFFD8799F581CF5808C2C990D86DA54BFC97D89CEE6EFA20CD8461616359478D96B4C582052BD1E5A642E2141E8FB7EA6FA996960BC91DB0B040C6D35013CF3EFECAC2DFCFF009FD8799FD8799F581C8D7526784EF72FE0CCDD085976ADA0DA88E7FB013E38E794B0923341454245415244FF1A00062112FFFFFF82583901814E1D11330F398CBF52DA38AD71926A3579C18D5F95D78FF6C64DF37EF835A10E065DBACA71D9604348BD140E67D10E23C3C7D40E2B10C51A0728E80A021A0004FC14031A0844757F075820A6D5E111373C28E492B40A5230816D74735B628F3AE78E3CC85CB162D7CA290209A1581CD195CA7DB29F0F13A00CAC7FCA70426FF60BAD4E1E87D3757FAE8484A14768764245415244080B58203E731E16CE923781489001473BBD204F4F5B63D0BFF730D847B5294ED0225B3B0D81825820A8A0BFC5E3AD6DFA48A31157CD1737113271F0F4ABF81765DD848089A8810B9D010E83581C4F641455F17911FE2F55AD3AD67FC2E0B2946B59AF3352574322E67E581C7FE3920105A0AEBAAECC1B935CD5EBBD3CC8C28336449D27378825E1581C814E1D11330F398CBF52DA38AD71926A3579C18D5F95D78FF6C64DF31082583901814E1D11330F398CBF52DA38AD71926A3579C18D5F95D78FF6C64DF37EF835A10E065DBACA71D9604348BD140E67D10E23C3C7D40E2B10C51A06DF51F0111A004C4B401281825820A598AC624F82ABF6E49A6F3562489E373B18F8F6063620F2C905A56AADF91C5A00AC008682582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E80082582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E80282582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E80382582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E80482582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E805825820C4826D2B10BF82F77D5668579AC810653543A904604BD6D81E4C0E2BE20B92E8010182A300581D718C5A532C6332F85E6A927750E129ABA954EEC6EAD209CD72D08F5A3201821A00E4E1C0A3581C25C5DE5F5B286073C593EDFD77B48ABC7A48E5A4F3D4CD9D428FF935A144555344431B0000360449218B2A581CBB9CF64BFCA2C8611AEFB81B5341EC5F7DBA39EC2B6464A4E8A13E51A14001581CF37E16045A5AA79503C1E3A36C0892A04A6F4471E4A097C9C98D3854A14004028201D818479F0000000000FF82583901DA299558C70A8970781806DCA93D1801BA2F3B3894227A7B284786E49BABA19195B7CB8B1C6FEBB192CC487B5E8B96D737BADDB8BB09866F1AD052404D021A000609DE031A08444EC9075820D36A2619A672494604E11BB447CBCF5231E9F2BA25C2169177EDC941BD50AD6C081A08444B450B5820FE9DC3C1D648F8EED13A06467141E04274CAD06809B6919326CA4517C832EA840D81825820C4826D2B10BF82F77D5668579AC810653543A904604BD6D81E4C0E2BE20B92E8010F011082583901DA299558C70A8970781806DCA93D1801BA2F3B3894227A7B284786E49BABA19195B7CB8B1C6FEBB192CC487B5E8B96D737BADDB8BB09866F1AD00BFEEB111A004C4B40128482582013A265B5FDF3BD287C30DA07427B90FBC0D7F5147EE27E1831498080C147C4E8018258204A686D10E241ABD38195CE47A4857AC191B647F13EC4DFDBAB33C0AD2FCAFEC300825820828B280093392E98A69996486321B4E1A8291998E0FE7A9BE6DEEB51F734D98900825820D87DC6BBE6E450D529A4514F4A85C7C450D88CED389F9FA73DFF0C47D4E3CF5D00A40081825820B70DB986DFDCAC122D8DEA2FD46148DF0D52BEAA8B9F5C1957E6AEF534E224B200018182583901EE17B587B28618EE9B12769801E0CEF4625762B8A2A29C95F89D2C21EE17B587B28618EE9B12769801E0CEF4625762B8A2A29C95F89D2C211B000000038F68F207021A00028759031A08483FC5A60084825820374056F437F749A703360DCFC48DA6D40C956DB95BC5851B80557794CD943BDD1859825820448B5581D33DB42EE60C6C6F9F5456D8B16A98CC12F9E1F9C8FDA0E260E17E30185C825820546CD4BD2115D97EF42C2435C978954BEB72FC4DED0D4A6957B06188CA684E501831825820D7BC12619246211B27FECDFA22517F992FFDD3FACBF6F90E37F4FDD98689CAFF1821018382583901A762BB598F45D5AF87F11779CE4B5336BFC2C2C7DAF0ADDD2AAB278A62F32A220120E877CCDD55FA86761EA7D93BA3CE6D6489E3C77AA6AC821A00191F54A4581C339EDCAD633AF825C1BB24D2B4277C63D3CA84357C1E27177B42B2DFA144544D494E01581C86F8493472E9048432DE4197E576AF6F6CAA4144C83EC63A67B79A3FA1465247454E535801581CBE9CA6E1EFF3A3175368BCF9C5AF4B5FD9ECB901450FEB481EBAC77CA1454141474958190C80581CCAA18329293A0FC71EAAD5B27DB33F27B47CDD58C0D3223977F46B70A146724941474F4E018258390106CFC004724E4309265426108AFB3803F92EB6A7556F3B641DCB000015B670EAAFC198195B0AC00EEAC5D20B65B965764D8140D8B17488671A05737C298258390106CFC004724E4309265426108AFB3803F92EB6A7556F3B641DCB000015B670EAAFC198195B0AC00EEAC5D20B65B965764D8140D8B17488671A004C4B40021A0002F47D031A0844757D05A1581DE115B670EAAFC198195B0AC00EEAC5D20B65B965764D8140D8B17488671A0595F2A00800A500818258204D78CF612314D74701925B6F21733DC4F3C6E7A32B28E8BA890B00A853BAE4AC00018182583901F0D829088263DED1FB14A88BE1BFB3E8E02AB92E291D4C4A3EBC1C688F3342EEC5F17686D68E13A68AE5CC6602DD185591775A85C92332F11B00000002560F5CFA021A00029E35031A08449FBC05A1581DE18F3342EEC5F17686D68E13A68AE5CC6602DD185591775A85C92332F11A0320793DA5008282582083EEAB7B859B66A9387A9F2C78382BDC2217877AA7ADA690A4C7D9C59AFA77A10082582083EEAB7B859B66A9387A9F2C78382BDC2217877AA7ADA690A4C7D9C59AFA77A101018282583901683E50145E2A146FBA95E87A30E98DAC4FC95C7028BB2B59ABCA2F74683E50145E2A146FBA95E87A30E98DAC4FC95C7028BB2B59ABCA2F741A000F424082583901683E50145E2A146FBA95E87A30E98DAC4FC95C7028BB2B59ABCA2F74683E50145E2A146FBA95E87A30E98DAC4FC95C7028BB2B59ABCA2F741A14743185021A0003917E031A3B9ACA0005A1581DE1683E50145E2A146FBA95E87A30E98DAC4FC95C7028BB2B59ABCA2F741A0086CC7DA5008282582052D8C79A39D9A3AF726372D3B36989CC953E3846EAA2D70F74C7E8DA7898E3F80082582052D8C79A39D9A3AF726372D3B36989CC953E3846EAA2D70F74C7E8DA7898E3F8010182825839013F917EB0DF493CEAA562A3CB0B18C48A01EDF28C5DF1188D992F66383F917EB0DF493CEAA562A3CB0B18C48A01EDF28C5DF1188D992F66381A000F4240825839013F917EB0DF493CEAA562A3CB0B18C48A01EDF28C5DF1188D992F66383F917EB0DF493CEAA562A3CB0B18C48A01EDF28C5DF1188D992F6638821B000000018F97126EA3581C269C0C6FB54095825E7F352EB667996872AF8D3A988E78595D5958F6A146544D494E763201581CB84D709A29B5F2F0F79D48941DF55D3E5823A1ECC290A6091D1F6841A34C437574794D616C3239333035014C437574794D616C3239333036014C437574794D616C323933303701581CE4BBBAA875A797578044EF27713D23DFE07CE74F33163E7C40D7F480A144544D494E01021A0003C556031A3B9ACA0005A1581DE13F917EB0DF493CEAA562A3CB0B18C48A01EDF28C5DF1188D992F66381A0029780E8BA20081825820FBC53E7AA4E5497D8662E8F0D5337441F629D1F237217BC24AC41BB6DE89F8415840EA148B1599B748217ED5A3C7852E5F89BFBA93C68DE36E9D0F0CF990043EE01CA6A87ADC80064B096E10AF1832215C285A2D8F160AC750AC2A8A9A77FDB122010582840000D8799F00029FD8799F0100FFFFFF821A000EFDD11A12C3436F840001D8799F00FF8219618A1A0066AFD8A10081825820393B3D3CAB6BE0897CBC87143CC3A24825DC1D8249DF4D37969502931CF856FF58408FB07FC71808B539D37FF3303ECB24BE497AB371FF571A541A1134CA51FAA8BD2365DD74D968F83452FBC198477495CC1073ABF27216D7CCA19453A824593703A10081825820AED1A7B47F61BEE6573CFD27181C9271BE6AC0FD2F0B013620E88B8B0E521BC75840831332C11952683DE001D60A765F1DDDE63776D171F9AFED55EBBE8EAD8168CFE9034FBA1B0BED6683CA7E3301B28676B53B8B45E0675C1718510097CDE83B0FA100D9010283825820D0B44D6A22841ADAFB1FA0294A8D7B994966C3F6E98E0C5251DA1DFED5A76E2158405E4E61DF69E4F7D25D3D9BD9432A8C8CD9BE9A34AD2A846CDA67FFA8C84E53B57DD0F92C6FD93A04D12333EE30E490DD7DD67B3F27D96C24A1CB4399B140700B825820F02163A5230F55881783214AF01653B8FDB45392B376E28CEA3B23E56480A88F5840907D0966AB17A29328631A15CA3109BF0A04928F219A33F12F51A44AFCDDE23CD7C71DC9E748F21C271A4B8BA6E37197BBEFA35E6B3A0A950A8F9FEC4110830782582061D2005E85D79E702CDC83FC0E890D59568D938BF9A5AD0E19BC133EA37EB76058404455009E1F678F930917E469D4D2120EBF349316982D6177FD36E1ABD4CEBFD841D322F27EFCBA04E65D19B4B6A3E6A84CB00075F85EA0124D49F9465163EA01A300848258205424FA10BA83C95C33714C420479C19183A7274E7C1D4161D173842C245B340C58402A550527CDCA1759A94035D2F56D6704125ACF953958023FF4E2FC007EA5597A8A665882DB8A7E70BC42234A4F82628019A08E573B1F14F512D383851E3D880E8258202DECD7E52458014264CB7C336E08824E1BDC31333AEAEB94A9A8FA7F1CAF6A275840DB5439BB91911BB34E60AD14E64DB1DBCE56BAAC07AB2DF9C4934D5EF2E3AB2662EC254CB2AB60F6D227FF5C8F729F077FB558279CF7F2F430CF9D826B7DA108825820D56B80334D8AE370256FBBB185AE46815A5E67676F7A97A76C5FED6BE808784758401CCD6327DF2F5F0E0A8DB90A765DB14AAD93518A2881D26B04AB3C1691F0F94817426DEC04A6ED0E067AA4DDE0E8526D6AB8B247F558832B903487F2F4537304825820FC1DC1D047E394103A1DCADC537994CAE3B7F08FB08D0200CC5E85E3AF16AA5858409A4C3C01C877BF2EEC0B1D658E8AA9856BFBC3E3CD6187286A62F0DA2D8605C5155A694240EE5932F0121FF78A682E835D5DCB61A166A39D5B8EAF43AE725D0001818200581C4F641455F17911FE2F55AD3AD67FC2E0B2946B59AF3352574322E67E0581840001D87980821A000CA1A61A0C8EC42DA20082825820F44CE6186D190F8776FD871D753DF7AE503972E4793A2360A423D2F96021E6015840190C46CB5A2F5BF6F262433D8BCE5835DAB959BB9C34F7064B70B050D78C71E8BB513D514E83CB9D3CFDB7456337523118015CDF2BE9F8EA56540F4D52CA540782582063179F731829D60AADE12A1398C07B7A905CC38E7D9901850C9B186946F5CA3E5840AFB5507C155030190ED67AF4FB4AD4D0A1B3BF5E9C484C188AED37779964AF79DC6BC153F28EA750A6E9842582D13052829892A20539A02D85FDBF50D594E00A0585840000D87980821A000CC80F1A13579C16840002D879808219FF441A014F9929840001D879808219FF441A014F9929840003D879808219FF441A014F9929840004D879808219FF441A014F9929A10081825820082137573F0C1A2C1DA89A4362C68B543AD06D40FDFFF2CB3ABAF55415A008A958402AB7BE62C1E47DB8BED432918CA3DA65F317166EBF83CD160ADEAFAACAA9AEC422A3EE3AA46F00C3D77EC7C4DB9FA154501A4A57E12A6CA7CBC65D7308234C06A10083825820E96948C0D58D889F8FD6A96998FD2D81BDB938BA02D70E4BB247C5C42F8EDCB05840A13B6BA03D4B787A096AC99E062E13C5BCEE78B445CBF38071C59AF78626EFDA278464D80CBF800E626492638076AA92444E0BF44953A1CD0AC3634B466CA506825820C4582835931C3157128A97E92368D91AEC6B99B6E346A644F8161CF5B785D1BD58409126CBA9CF8C2DE47257F06BFBDFA9A80A49FE5B85A1B3F09F2EE430AE5D4D83867DA7A58250FC819655D9AD02D43C9B43C33E68BDFF4F4D7E96142F0584160E8258206309F446E5A6A610A2772B6B79F9F732A242394DFA11AF85E93C614D9B1F061758401CFD4305ABB7944D71693AA37ABA95DAB88DACE9459B9595A43C17C01FAD3BA7104CBC98FBA52EF47C4B798ABEF6436549A8063D92C7A06D8C2A85FEE1DABF0EA100828258200A0BE7275F9E21BF296834661D8A7561DA758E3964697908165FBEA1E044AD8358409C30A946A3D4FDBFAD7F429DD20ECE8E53842273BBD403CCB1F6A67BFF14F680B026B41C8E1F6A80C9F7BB905C1C5F4B07007CBF5B9CAD319FEFCEF8F830D101825820013EADB6FF091D95D7AF8C6C5985265E13D37FF0A691C9C17EC6B2C1754AC04C58403B84248F24131BE536AFF944CDA14CE511B591493729A91ECA3C40DC6F1AB5D095C89F46AC2705C3F4538EA52882EE6261045650ACFA9D0AF3B5BEEBAACE9D00A100838258202739D5760F6856FE47ABF08711E4A07FBD3CE16E8EDF2468E212025B15A2919F5840E69001A30506D10AD31E9BFE3481EC84288D0CC4F7736D4BEBACD13CDA5936F1790E23781CA7A4073A8F580051F176B9FE18237E312661AC4D96B75F33405F0E8258202739D5760F6856FE47ABF08711E4A07FBD3CE16E8EDF2468E212025B15A2919F5840E69001A30506D10AD31E9BFE3481EC84288D0CC4F7736D4BEBACD13CDA5936F1790E23781CA7A4073A8F580051F176B9FE18237E312661AC4D96B75F33405F0E8258202739D5760F6856FE47ABF08711E4A07FBD3CE16E8EDF2468E212025B15A2919F5840E69001A30506D10AD31E9BFE3481EC84288D0CC4F7736D4BEBACD13CDA5936F1790E23781CA7A4073A8F580051F176B9FE18237E312661AC4D96B75F33405F0EA100838258202AC7E4E3A3CE0209BD8F38AD6D112FFB2634D6689EF44FF2A28845F7F1E4C3D9584018CCB8B8264B8C56571FAD729E3F420F228B6071804E372EF759C4B791588892995224A6E2A0A6D41613F25F1936C103066D8E9C6D9509EB513D9DD80AAC55078258202AC7E4E3A3CE0209BD8F38AD6D112FFB2634D6689EF44FF2A28845F7F1E4C3D9584018CCB8B8264B8C56571FAD729E3F420F228B6071804E372EF759C4B791588892995224A6E2A0A6D41613F25F1936C103066D8E9C6D9509EB513D9DD80AAC55078258202AC7E4E3A3CE0209BD8F38AD6D112FFB2634D6689EF44FF2A28845F7F1E4C3D9584018CCB8B8264B8C56571FAD729E3F420F228B6071804E372EF759C4B791588892995224A6E2A0A6D41613F25F1936C103066D8E9C6D9509EB513D9DD80AAC5507A204A11902A2A1636D736781781B4D696E737761703A205632205374616B65206C697175696469747905A080")]
    public async Task DeserializeBlock(string cbor)
    {
        byte[] cborRaw = Convert.FromHexString(cbor);

        const int concurrencyLevel = 1;   // Number of parallel tasks
        const int iterationsPerTask = 1; // Number of deserializations per task

        List<Task> tasks = Enumerable.Range(0, concurrencyLevel).Select(_ => Task.Run(() =>
        {
            for (int i = 0; i < iterationsPerTask; i++)
            {
                // This call should be thread-safe and never fail if the code is correct
                Block block = CborSerializer.Deserialize<Block>(cborRaw);

                // If block is occasionally null or exceptions occur, it's a sign of a concurrency issue
                Assert.NotNull(block);
            }
        })).ToList();

        // Await all tasks to complete; if any fail, the test will fail
        await Task.WhenAll(tasks);
    }
}
