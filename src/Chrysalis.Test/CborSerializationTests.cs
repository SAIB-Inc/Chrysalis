using System.Reflection;
using Chrysalis.Cardano.Models.Core.Block;
using Chrysalis.Cbor;
using Xunit;

namespace Chrysalis.Test;

public class CborSerializerTests
{
    [Theory]
    [InlineData("820785828A1A0024CD2E1A0371649158207063CB55F1E55FD80ACA1EE582A7B489856D704B46E213E268BAD14A56F09F355820DF89101296FEC1DC3D62E6C1E595EAFF22CC0DFC67E131EF14BA8C4772D3A766582008A1ECFFBDD94FCA7FCFE54414140DBCC8D24D8AD2F34441F60E6FA0F6F746CB8258405A7828A8C947E79CE13A1B32D934FFD8789C54038302F8E3D976CD19C38485F7CF70082745521FA33863E4597C9B9974E2F0C4910BBAA49A310FD1E092FA13F75850CED8E6382838205756E102E3E7AFC248FB3381CF1AF37BE30719484AFCC8DEE389382A9A44B563AAB1ABC9287191DE9E85A1FB1C657BF256949DC9A7557F0B32EE7F1395ECB9523E33AD2F2343A534021901CC582060DF41E05AE45C3FB2708ECFB3A994C64D1F05CE5FC77CFFE9228402F8D76F0084582009BA7F385DB65A62DE6FDEF0138CB71938A19989DF420823E1B76BDB7FFEC509071901AA584084216A98801BD9AD1659F71ACAE918E5B1B6FB0D547B8C8CD4F70390D58693E179D1FFA5B4266FABA220E01474B7B8DF9521C1DC894C9D7472EE10D898B9CF0C820A005901C01BCB316E37A1CA580FAA30502B3F31A339B4FA92BCA969C88D394B1BEDE8933AE2430E673D9CD96A800218AA91F08F4B864F9794FD4DDF220FD71D6ED8B1800489355395AD17B6301DB3E36E757A27CD9845C1A02B208400CEBA4EFECF19F0FEAE8DD413CAA750D76A7E16074D1698DEEDA6546C3459304F2C6FEA0F9EAB026FE19350A8EFDAB8F18D62091A0A0F765CAD08347985CB0156FA4B2E7E7A766782588639C32EB8074FBC111020A5F133922D364BA28D0F8EEA8140E17832928379BE25BB3FD57C50434452706CB52D9A6FC9F6D45E558AC34F73E1050B6689B42FAD45713D63C613033B22D0E5253A3D2CC3BBB9D0B986C07F17D38594AA5023C244CD4B0486976F584118FEBA2D62E700F92A67E46EF4E034DBF5C57E52DE15A19AC064C1A6959506AA5848347CCC2B40B9B09C4D73F66F4AF6B504D38C568378970BB1CFAAEF9F97A539BE83E8A9D2E967E2DC44410CBF0A9CBE541907B6EC09F8241AF4793E66B41444F4D901E00961F5A78A9824F8E93D4C6A7576C821C8CB3C798B1140C82FF17D3F0F067CCEC6A6A219B2F80CB89BD3404BB2185D9AD6DCD81F9E7DAB77F373BF62B7F1995B0CB65540E773F7104B6BA4758FF81DAD4FA281A400818258202122C2504552727508EB11F189125786B8BEA0C3955E1BD989D8A631980363F6000181825839009FC430EA1F3ADC20EEBB813B2649E85C934EA5BC13D7B7FBE2B24E505064B671634D14CB8D543E71DD8EB437A47EFB47B0B22882866C420D821B00000001FDD58A0AA2581C22691D3D969ECF5802226290C2FB98E2BC08522D5B726C1F5F400105A144546573740D581CEF6ED47A6917A3CBBEB46561E8853DA969343794D66128598A34AF2CA24D4275726E61626C65546F6B656E024E4275726E61626C65546F6B656E3202021A0002ADD905A1581DE05064B671634D14CB8D543E71DD8EB437A47EFB47B0B22882866C420D0081A100828258200DD2349193F4D73BFF8ED9FEA7965E3C44BDC098F1D91D0A2C9AF8AA525DB71B5840B30C80EEB8E2B07E38D9E411BED9F3D5FD344C6557FBEA8102A49EA542143A3A4400FE47DE5ECF4CAFB69906556BF4E7F9B7146AE7463F4DDE6C780B500420088258200ABB7B89E091DCD3201AEA501854A4CB05290862D88B6EB30AFA6DFD23F5446758403E563CDF0E8B72049CA05C8C7214254588B3A23C5FE863A514D1B816E6A0FA3499F927F47CD8F18A75D7FCC782A68A5ED84AAE5CFD2C66FE73E79A8540564F0AA080", typeof(MultiEraBlock))]
    public void SerializeAndDeserializePrimitives(string cborHex, Type type)
    {
        // Arrange
        byte[] cborBytes = Convert.FromHexString(cborHex);

        // Act
        MethodInfo? deserializeMethod = typeof(CborSerializer).GetMethod(nameof(CborSerializer.Deserialize));
        Assert.NotNull(deserializeMethod);

        MethodInfo? genericDeserializeMethod = deserializeMethod?.MakeGenericMethod(type);
        Assert.NotNull(genericDeserializeMethod);

        object? cborObject = genericDeserializeMethod?.Invoke(null, [cborBytes]);
        Assert.NotNull(cborObject);

        byte[] serializedBytes = CborSerializer.Serialize((ICbor)cborObject);
        string serializedHex = Convert.ToHexString(serializedBytes).ToLowerInvariant();

        // Assert
        Assert.Equal(cborHex.ToLowerInvariant(), serializedHex);
    }
}